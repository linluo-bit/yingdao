<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPAå…ƒç´ æ•è·æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 10px;
        }
        .button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #106ebe;
        }
        .button.secondary {
            background-color: #6c757d;
        }
        .button.secondary:hover {
            background-color: #5a6268;
        }
        .button.success {
            background-color: #28a745;
        }
        .button.success:hover {
            background-color: #218838;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-group textarea {
            height: 80px;
            resize: vertical;
        }
        .capture-info {
            background-color: #e7f3ff;
            border: 1px solid #0078d4;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .capture-info h4 {
            margin-top: 0;
            color: #0078d4;
        }
        .element-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .highlight {
            outline: 3px solid #0078d4 !important;
            outline-offset: 2px !important;
            background-color: rgba(0, 120, 212, 0.1) !important;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        .notification.success {
            background-color: #28a745;
        }
        .notification.error {
            background-color: #dc3545;
        }
        .notification.info {
            background-color: #0078d4;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .table th, .table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .link {
            color: #0078d4;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .image {
            max-width: 200px;
            height: auto;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” RPAå…ƒç´ æ•è·æµ‹è¯•é¡µé¢</h1>
            <p>æµ‹è¯•å„ç§ç½‘é¡µå…ƒç´ çš„æ•è·åŠŸèƒ½</p>
        </div>

        <!-- å…ƒç´ æ•è·æ§åˆ¶åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ¯ å…ƒç´ æ•è·æ§åˆ¶</h3>
            <div class="capture-info">
                <h4>ä½¿ç”¨è¯´æ˜ï¼š</h4>
                <p><strong>æ–¹æ³•1ï¼ˆæ¨èï¼‰ï¼š</strong> ç‚¹å‡»ä¸‹æ–¹"å¼€å§‹æ•è·"æŒ‰é’®ï¼Œç„¶åç‚¹å‡»é¡µé¢ä¸Šçš„ä»»æ„å…ƒç´ </p>
                <p><strong>æ–¹æ³•2ï¼š</strong> æŒ‰ä½Ctrlé”®ï¼Œç„¶åç‚¹å‡»é¡µé¢ä¸Šçš„ä»»æ„å…ƒç´ </p>
                <p><strong>æ³¨æ„ï¼š</strong> æ•è·çš„å…ƒç´ ä¿¡æ¯ä¼šè‡ªåŠ¨ä¿å­˜åˆ°localStorageï¼Œå¹¶å°è¯•å‘é€åˆ°RPAåº”ç”¨</p>
            </div>
            
            <button id="startCapture" class="button success">ğŸš€ å¼€å§‹æ•è·</button>
            <button id="stopCapture" class="button secondary">â¹ï¸ åœæ­¢æ•è·</button>
            <button id="clearData" class="button">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
            <button id="viewData" class="button">ğŸ“Š æŸ¥çœ‹æ•°æ®</button>
            
            <div id="captureStatus" class="element-display" style="display: none;">
                <strong>æ•è·çŠ¶æ€ï¼š</strong> <span id="statusText">æœªå¼€å§‹</span>
            </div>
        </div>

        <!-- æŒ‰é’®æµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ”˜ æŒ‰é’®å…ƒç´ æµ‹è¯•</h3>
            <button id="test-button" class="button">ä¸»è¦æŒ‰é’®</button>
            <button class="button secondary">æ¬¡è¦æŒ‰é’®</button>
            <button class="button success">æˆåŠŸæŒ‰é’®</button>
            <button class="button" style="background-color: #dc3545;">å±é™©æŒ‰é’®</button>
            <button class="button" disabled>ç¦ç”¨æŒ‰é’®</button>
        </div>

        <!-- è¡¨å•å…ƒç´ æµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ“ è¡¨å•å…ƒç´ æµ‹è¯•</h3>
            <div class="input-group">
                <label for="username">ç”¨æˆ·åï¼š</label>
                <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" value="testuser">
            </div>
            <div class="input-group">
                <label for="email">é‚®ç®±ï¼š</label>
                <input type="email" id="email" name="email" placeholder="è¯·è¾“å…¥é‚®ç®±" value="test@example.com">
            </div>
            <div class="input-group">
                <label for="password">å¯†ç ï¼š</label>
                <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " value="123456">
            </div>
            <div class="input-group">
                <label for="message">æ¶ˆæ¯ï¼š</label>
                <textarea id="message" name="message" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹">è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯</textarea>
            </div>
            <div class="input-group">
                <label for="country">å›½å®¶ï¼š</label>
                <select id="country" name="country">
                    <option value="">è¯·é€‰æ‹©å›½å®¶</option>
                    <option value="cn" selected>ä¸­å›½</option>
                    <option value="us">ç¾å›½</option>
                    <option value="jp">æ—¥æœ¬</option>
                    <option value="kr">éŸ©å›½</option>
                </select>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="agree" name="agree" checked> æˆ‘åŒæ„æœåŠ¡æ¡æ¬¾
                </label>
            </div>
            <div class="input-group">
                <label>æ€§åˆ«ï¼š</label>
                <label><input type="radio" name="gender" value="male" checked> ç”·</label>
                <label><input type="radio" name="gender" value="female"> å¥³</label>
            </div>
        </div>

        <!-- é“¾æ¥å’Œå›¾ç‰‡æµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ”— é“¾æ¥å’Œå›¾ç‰‡æµ‹è¯•</h3>
            <p>è¿™æ˜¯ä¸€ä¸ª<a href="#" class="link">æ™®é€šé“¾æ¥</a>ï¼Œç‚¹å‡»æµ‹è¯•æ•è·ã€‚</p>
            <p>è¿™æ˜¯ä¸€ä¸ª<a href="https://www.baidu.com" class="link" target="_blank">å¤–éƒ¨é“¾æ¥</a>ï¼Œä¼šæ‰“å¼€æ–°çª—å£ã€‚</p>
            <p>è¿™æ˜¯ä¸€ä¸ª<a href="mailto:test@example.com" class="link">é‚®ä»¶é“¾æ¥</a>ã€‚</p>
            <p>è¿™æ˜¯ä¸€ä¸ª<a href="tel:+1234567890" class="link">ç”µè¯é“¾æ¥</a>ã€‚</p>
            
            <div style="margin: 20px 0;">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlRlc3QgSW1hZ2U8L3RleHQ+Cjwvc3ZnPgo=" alt="æµ‹è¯•å›¾ç‰‡" class="image">
            </div>
        </div>

        <!-- è¡¨æ ¼æµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ“Š è¡¨æ ¼å…ƒç´ æµ‹è¯•</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å¹´é¾„</th>
                        <th>èŒä¸š</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>å¼ ä¸‰</td>
                        <td>25</td>
                        <td>å·¥ç¨‹å¸ˆ</td>
                        <td><button class="button">ç¼–è¾‘</button></td>
                    </tr>
                    <tr>
                        <td>æå››</td>
                        <td>30</td>
                        <td>è®¾è®¡å¸ˆ</td>
                        <td><button class="button">ç¼–è¾‘</button></td>
                    </tr>
                    <tr>
                        <td>ç‹äº”</td>
                        <td>28</td>
                        <td>äº§å“ç»ç†</td>
                        <td><button class="button">ç¼–è¾‘</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ•è·ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ•è·ç»“æœ</h3>
            <div id="capturedElement" class="element-display">
                ç­‰å¾…æ•è·å…ƒç´ ...
            </div>
        </div>
    </div>

    <script>
        // å…ƒç´ æ•è·å™¨ç±»
        class ElementCapture {
            constructor() {
                this.isCapturing = false;
                this.capturedElements = [];
                this.init();
            }

            init() {
                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('startCapture').addEventListener('click', () => this.startCapture());
                document.getElementById('stopCapture').addEventListener('click', () => this.stopCapture());
                document.getElementById('clearData').addEventListener('click', () => this.clearData());
                document.getElementById('viewData').addEventListener('click', () => this.viewData());

                // ç»‘å®šé”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
                
                // ç»‘å®šé¼ æ ‡äº‹ä»¶
                document.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                document.addEventListener('mouseover', (e) => this.handleMouseOver(e));
                document.addEventListener('mouseout', (e) => this.handleMouseOut(e));

                this.updateStatus('å°±ç»ª');
            }

            startCapture() {
                this.isCapturing = true;
                this.updateStatus('æ­£åœ¨æ•è· - ç‚¹å‡»ä»»æ„å…ƒç´ ');
                this.showNotification('å…ƒç´ æ•è·å·²å¼€å§‹', 'info');
            }

            stopCapture() {
                this.isCapturing = false;
                this.removeHighlight();
                this.updateStatus('å·²åœæ­¢');
                this.showNotification('å…ƒç´ æ•è·å·²åœæ­¢', 'info');
            }

            handleKeyDown(event) {
                if (event.key === 'Control') {
                    this.isCapturing = true;
                    this.updateStatus('æ­£åœ¨æ•è· - ç‚¹å‡»ä»»æ„å…ƒç´ ');
                }
            }

            handleKeyUp(event) {
                if (event.key === 'Control') {
                    this.isCapturing = false;
                    this.removeHighlight();
                    this.updateStatus('å°±ç»ª');
                }
            }

            handleMouseOver(event) {
                if (this.isCapturing) {
                    this.highlightElement(event.target);
                }
            }

            handleMouseOut(event) {
                if (this.isCapturing) {
                    this.removeHighlight();
                }
            }

            handleMouseDown(event) {
                if (this.isCapturing) {
                    event.preventDefault();
                    this.captureElement(event.target, event);
                }
            }

            highlightElement(element) {
                this.removeHighlight();
                element.classList.add('highlight');
            }

            removeHighlight() {
                const highlighted = document.querySelector('.highlight');
                if (highlighted) {
                    highlighted.classList.remove('highlight');
                }
            }

            captureElement(element, event) {
                const elementInfo = this.getElementInfo(element);
                
                // æ˜¾ç¤ºæ•è·æˆåŠŸæç¤º
                this.showCaptureSuccess(elementInfo);
                
                // ä¿å­˜åˆ°localStorage
                this.saveToLocalStorage(elementInfo);
                
                // å‘é€åˆ°RPAåº”ç”¨
                this.sendToRPAApp(elementInfo);
                
                // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
                this.displayCapturedElement(elementInfo);
                
                console.log('å…ƒç´ å·²æ•è·:', elementInfo);
            }

            getElementInfo(element) {
                const rect = element.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(element);
                
                return {
                    tagName: element.tagName.toLowerCase(),
                    id: element.id || '',
                    className: element.className || '',
                    text: element.textContent?.trim().substring(0, 50) || '',
                    xpath: this.getXPath(element),
                    cssSelector: this.getCSSSelector(element),
                    position: {
                        x: rect.left + window.scrollX,
                        y: rect.top + window.scrollY,
                        width: rect.width,
                        height: rect.height
                    },
                    attributes: this.getAttributes(element),
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
            }

            getXPath(element) {
                if (element.id) {
                    return `//*[@id="${element.id}"]`;
                }
                
                if (element === document.body) {
                    return '/html/body';
                }
                
                let path = '';
                while (element && element.nodeType === Node.ELEMENT_NODE) {
                    let index = 1;
                    let sibling = element.previousSibling;
                    
                    while (sibling) {
                        if (sibling.nodeType === Node.ELEMENT_NODE && sibling.tagName === element.tagName) {
                            index++;
                        }
                        sibling = sibling.previousSibling;
                    }
                    
                    const tagName = element.tagName.toLowerCase();
                    const pathIndex = index > 1 ? `[${index}]` : '';
                    path = `/${tagName}${pathIndex}${path}`;
                    
                    element = element.parentNode;
                }
                
                return path;
            }

            getCSSSelector(element) {
                if (element.id) {
                    return `#${element.id}`;
                }
                
                let selector = element.tagName.toLowerCase();
                
                if (element.className) {
                    const classes = element.className.split(' ').filter(c => c.trim());
                    if (classes.length > 0) {
                        selector += '.' + classes.join('.');
                    }
                }
                
                // æ·»åŠ å±æ€§é€‰æ‹©å™¨
                const attributes = ['name', 'type', 'value', 'title', 'alt'];
                for (const attr of attributes) {
                    if (element.hasAttribute(attr)) {
                        selector += `[${attr}="${element.getAttribute(attr)}"]`;
                    }
                }
                
                return selector;
            }

            getAttributes(element) {
                const attributes = {};
                for (const attr of element.attributes) {
                    attributes[attr.name] = attr.value;
                }
                return attributes;
            }

            showCaptureSuccess(elementInfo) {
                this.showNotification(`âœ… å…ƒç´ å·²æ•è·: ${elementInfo.tagName}${elementInfo.id ? '#' + elementInfo.id : ''}`, 'success');
            }

            saveToLocalStorage(elementInfo) {
                try {
                    // ä¿å­˜åˆ°localStorage
                    const storageKey = 'rpa_captured_element_' + Date.now();
                    localStorage.setItem(storageKey, JSON.stringify(elementInfo));
                    
                    // åŒæ—¶ä¿å­˜æœ€æ–°çš„å…ƒç´ ä¿¡æ¯
                    localStorage.setItem('rpa_last_captured_element', JSON.stringify(elementInfo));
                    localStorage.setItem('rpa_last_capture_time', Date.now().toString());
                    
                    console.log('å…ƒç´ ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage:', storageKey);
                } catch (error) {
                    console.error('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
                    this.showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }

            sendToRPAApp(elementInfo) {
                // å°è¯•å‘é€åˆ°RPAåº”ç”¨çš„HTTPæœåŠ¡å™¨
                const rpaServerUrl = 'http://localhost:3000/capture_element';
                
                fetch(rpaServerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'element_captured',
                        element: elementInfo
                    })
                })
                .then(response => {
                    if (response.ok) {
                        console.log('å…ƒç´ ä¿¡æ¯å·²å‘é€åˆ°RPAåº”ç”¨');
                        this.showNotification('å…ƒç´ ä¿¡æ¯å·²å‘é€åˆ°RPAåº”ç”¨', 'success');
                    } else {
                        console.log('RPAåº”ç”¨å“åº”é”™è¯¯ï¼Œä½†æ•°æ®å·²ä¿å­˜åˆ°localStorage');
                    }
                })
                .catch(error => {
                    console.log('æ— æ³•è¿æ¥åˆ°RPAåº”ç”¨ï¼Œä½†æ•°æ®å·²ä¿å­˜åˆ°localStorage:', error);
                });
                
                // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶æœåŠ¡å™¨ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                const fileServerUrl = 'http://localhost:8080/save_element';
                fetch(fileServerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(elementInfo)
                })
                .then(response => {
                    if (response.ok) {
                        console.log('å…ƒç´ ä¿¡æ¯å·²ä¿å­˜åˆ°æ–‡ä»¶æœåŠ¡å™¨');
                    } else {
                        console.log('æ–‡ä»¶æœåŠ¡å™¨å“åº”é”™è¯¯');
                    }
                })
                .catch(error => {
                    console.log('æ— æ³•è¿æ¥åˆ°æ–‡ä»¶æœåŠ¡å™¨:', error);
                });
            }

            displayCapturedElement(elementInfo) {
                const display = document.getElementById('capturedElement');
                display.textContent = JSON.stringify(elementInfo, null, 2);
            }

            updateStatus(status) {
                const statusElement = document.getElementById('captureStatus');
                const statusText = document.getElementById('statusText');
                statusElement.style.display = 'block';
                statusText.textContent = status;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            clearData() {
                try {
                    const keysToRemove = [];
                    
                    // æ”¶é›†æ‰€æœ‰RPAç›¸å…³çš„é”®
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('rpa_') || key.includes('captured_element'))) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    // åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    document.getElementById('capturedElement').textContent = 'æ•°æ®å·²æ¸…é™¤';
                    this.showNotification(`å·²æ¸…é™¤ ${keysToRemove.length} ä¸ªæ•°æ®é¡¹`, 'success');
                } catch (error) {
                    this.showNotification('æ¸…é™¤æ•°æ®å¤±è´¥', 'error');
                }
            }

            viewData() {
                try {
                    const elementData = localStorage.getItem('rpa_last_captured_element');
                    const captureTime = localStorage.getItem('rpa_last_capture_time');
                    
                    if (elementData) {
                        const element = JSON.parse(elementData);
                        const time = new Date(parseInt(captureTime)).toLocaleString();
                        
                        const display = document.getElementById('capturedElement');
                        display.textContent = `æ•è·æ—¶é—´: ${time}\n\nå…ƒç´ ä¿¡æ¯:\n${JSON.stringify(element, null, 2)}`;
                    } else {
                        document.getElementById('capturedElement').textContent = 'æ²¡æœ‰æ‰¾åˆ°æ•è·çš„å…ƒç´ æ•°æ®';
                    }
                } catch (error) {
                    document.getElementById('capturedElement').textContent = `è¯»å–å¤±è´¥: ${error.message}`;
                }
            }
        }

        // åˆå§‹åŒ–å…ƒç´ æ•è·å™¨
        const elementCapture = new ElementCapture();
    </script>
</body>
</html> 